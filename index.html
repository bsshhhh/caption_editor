<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>인스타 이미지 텍스트 합성기</title>

  <!-- Pretendard -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard/dist/web/static/pretendard.css">

  <!-- MaruBuri (네이버 한글 웹폰트) -->
  <link href="https://hangeul.pstatic.net/hangeul_static/css/maru-buri.css" rel="stylesheet">

  <style>
    html, body {
      -webkit-text-size-adjust: 100%;
    }

    :root {
      font-size: 16px;
    }

    body {
      margin: 0;
      font-family: Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f3f4f6;
      padding: 2vw;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }

    h2 { margin-top: 0; font-size: 1.5rem; }
    .section { margin-bottom: 2rem; }

    textarea,
    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 0.9rem;
      font-size: 1rem;
      border-radius: 0.6rem;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
    }

    canvas {
      max-width: 100%;
      display: block;
      margin-top: 1rem;
      background: #111;
      border-radius: 0.8rem;
    }

    button {
      width: 100%;
      padding: 1rem 0;
      border-radius: 0.6rem;
      border: none;
      cursor: pointer;
      background: #4f46e5;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 1rem;
      transition: transform 0.1s;
    }

    button:hover:not(:disabled) { transform: scale(1.03); }

    /* 모바일 최적화 */
    @media (max-width: 768px) {
      :root { font-size: 20px; }
      body { padding: 5vw; }
      button { font-size: 1.2rem; padding: 1.2rem; }
      textarea, input, select { font-size: 1.2rem; padding: 1.2rem; }
    }

    .hidden { display: none; }
  </style>

</head>

<body>
<div class="container">

  <!-- STEP 1 -->
  <div class="section">
    <h2>1. 이미지 업로드</h2>
    <input type="file" id="imageInput" accept="image/*" />
  </div>

  <!-- STEP 2 -->
  <div id="textSection" class="section hidden">
    <h2>2. 텍스트 입력</h2>

    <textarea id="textInput" placeholder="최대 2줄까지 입력 가능"></textarea>

    <div style="margin-top: 16px;">
      <label>글자 크기(px)</label>
      <input id="fontSizeInput" type="number" value="80" />
    </div>

    <div style="margin-top: 16px;">
      <label>세로 위치</label>
      <select id="positionSelect">
        <option value="bottom">아래</option>
        <option value="middle">가운데</option>
        <option value="top">위</option>
      </select>
    </div>

    <div style="margin-top: 16px;">
      <label>가로 정렬</label>
      <select id="alignSelect">
        <option value="center">가운데</option>
        <option value="left">왼쪽</option>
        <option value="right">오른쪽</option>
      </select>
    </div>

    <div style="margin-top: 16px;">
      <label>폰트 선택</label>
      <select id="fontSelect">
        <option value="Pretendard">프리텐다드</option>
        <option value="MaruBuri">마루부리</option>
      </select>
    </div>

    <div style="margin-top: 16px;">
      <label>글자 색</label>
      <input id="colorInput" type="color" value="#ffffff" />
    </div>

    <canvas id="canvas"></canvas>

    <button id="downloadBtn">이미지 다운로드</button>
  </div>

</div>

<script>
  const imageInput = document.getElementById("imageInput");
  const textSection = document.getElementById("textSection");

  const textInput = document.getElementById("textInput");
  const fontSizeInput = document.getElementById("fontSizeInput");
  const positionSelect = document.getElementById("positionSelect");
  const alignSelect = document.getElementById("alignSelect");
  const colorInput = document.getElementById("colorInput");
  const fontSelect = document.getElementById("fontSelect");

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  let img = new Image();
  let imageLoaded = false;

  /* STEP 1 — 업로드 → 바로 텍스트 섹션 열림 */
  imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      img.onload = () => {
        imageLoaded = true;
        textSection.classList.remove("hidden");

        document.fonts.ready.then(() => redraw());
      };

      img.src = event.target.result;
    };

    reader.readAsDataURL(file);
  });

  /* 텍스트 관련 이벤트 */
  textInput.addEventListener("input", () => {
    const lines = textInput.value.split("\n");
    if (lines.length > 2) textInput.value = lines.slice(0, 2).join("\n");
    redraw();
  });

  fontSizeInput.addEventListener("input", redraw);
  positionSelect.addEventListener("change", redraw);
  alignSelect.addEventListener("change", redraw);
  colorInput.addEventListener("input", redraw);
  fontSelect.addEventListener("change", redraw);

  /* 자동 줄바꿈 */
  function wrapText(context, text, maxWidth) {
    const paragraphs = text.split(/\n/);
    const lines = [];

    paragraphs.forEach((para) => {
      const words = para.split(/\s+/);
      let line = "";

      words.forEach((word) => {
        if (!word) return;
        const testLine = line ? line + " " + word : word;
        const { width } = context.measureText(testLine);

        if (width > maxWidth && line) {
          lines.push(line);
          line = word;
        } else {
          line = testLine;
        }
      });

      if (line) lines.push(line);
    });

    return lines;
  }

  function redraw() {
    if (!imageLoaded) return;

    const text = textInput.value || "";
    const fontSize = parseInt(fontSizeInput.value, 10);
    const color = colorInput.value;
    const fontFamily = fontSelect.value;

    canvas.width = img.width;
    canvas.height = img.height;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    if (!text.trim()) return;

    ctx.font = `700 ${fontSize}px ${fontFamily}`;
    ctx.textAlign = alignSelect.value;
    ctx.textBaseline = "middle";
    ctx.fillStyle = color;

    const lines = wrapText(ctx, text, canvas.width * 0.9);
    const lineHeight = fontSize * 1.3;
    const totalHeight = lineHeight * (lines.length - 1);

    let startY =
      positionSelect.value === "top"
        ? canvas.height * 0.12
        : positionSelect.value === "middle"
        ? canvas.height / 2 - totalHeight / 2
        : canvas.height * 0.88 - totalHeight;

    let centerX =
      alignSelect.value === "left"
        ? canvas.width * 0.1
        : alignSelect.value === "right"
        ? canvas.width * 0.9
        : canvas.width / 2;

    lines.forEach((line, idx) => {
      ctx.fillText(line, centerX, startY + idx * lineHeight);
    });
  }

  /* 다운로드 */
  document.getElementById("downloadBtn").addEventListener("click", () => {
    canvas.toBlob((blob) => {
      const blobUrl = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = "insta-image.png";
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(blobUrl);
    });
  });
</script>

</body>
</html>
